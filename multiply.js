var savedTime = 0;
var timePerRound = 0;
var rounds = 0;
var gridX = 0;
var gridY = 0;
var max = 0;
var xVal = new Array(gridX);
var yVal = new Array(gridY);
var isClassroomMode = false;
var seed = 0;
var pool = "31173856552573591923537612233284129341351243196315191569156567547277396582316538712182382265933744274792657135512892586122143456951418522676815854876469585371189252766282535389274131221851994685951622875689245855717363281783267991364838723183171478215575262236971614225993815473429912188959435517684798741332593383816956224494669285941752936586956961843636444512229883729199537756524336612211776268152711171496486879687915789354122216194777347216664819285173544816257182246457568338757686147829397457155268242522456395545316258857262546313276279419679316837781462581948141732362319273557558416839364834865219557538894551919175541875272922857373524266772252225589812432376187523868211745295317442141458819153533458747598657273146992381485336841942486286954843453275229226175645479868634987475125356235553515851297975216479286345968541876763239468394288917922849681699489891714571758918922518727973395545565978637774539672417338236879841479493341463887127781451961964877322988297395567792152337778222595949234562761568561111921722377953819349466383122317387893213496771533477236844934147873919969324111137719427841737828159933718798125441833587553828538393127122334199218756996948737952822675623151177991451741727873552928373719678578213646419399459745263399214444326192648625688554992949265449154372535299213259676674948414793876417228476748538951964664312729665826479842636111529735334659492141463621776247219311754122824176491437363188585668298398721148744258858152344436771796759854669613556153885665652748615927863127862489234279221667532487963458413736436168199114246861629667223388652388854172993746252343552498471467494776727119471654746494352276549225645974468419691571124232322291182194755969454234645989431556492752548354922197547111434971436656297981471178384373975636764945983423963848133514215421166296755189526884813167338387566946496866461421345695397893766724693615959863438834891878375815558759891712861857312915564363332567165653821323113915882423688171274172667888596535318342146578824949146459623791398273232176198422885341196299786992852646562692372493826213129871557846631676469661442543965342638139883672434144763552476671871841393835429366123881234494199385348727396482444343591688185515518289775818445526425796821875976437465148289869529385877578978755358715947456514436951288829922793471437822524644662994731939918986278225252666725263381151388136724489189643169613282419938793173339154133484913874438542493495629679743513299729986284244766263926379528388985817414461779416236727577344819788287788356399157738272963642497225931134119154977357226441898674741455361242917998496129834158421714619887447338677661949673952766342463858113394861415289941963618345691783899239965787282358162715398372961893847632692492944695151868835751312775768762724639257638446155912314639338387725989592954856584887224538818998684825418525965388415874477554133315466665394957726534236924536429449851927922533674771543697681543233581266123783412592999229848234263787999223353434264556396244241721396691628635868512687553852315215979946727463349467112259848986531231543818415811363968977943723321244335829794962448544636617734274578315118295669743665129621311285435228147943932312916276451446826686292659422287611135657266786923366871928823451517966474457378693878732131745615931768863165441785193184162891391966699532292297425996413792588926997255243887759453568354371915735832887412858135152643251186948989477382912466784245286263463739246164323986179322613895237651118542486597232824793897122551445885197437989767586723378736262419573725521365693388649758718172479932833432275422768233377242638751916869966976586389313172312832139573495515824161424558991824275255916471818959645333549463251528292136215196685354746967673132259466191137532814494468153654271258839475565431255384742279273863325246757147788642431374412478151511538339917255996655223658862428759453397514295254535561569532919244323288776972743327278921698986889146411378839622746694418654563813745159776326249924319727964145693574784449276317697663256972387923922855167512722638445259295228353225419383787371561676219569331811225621389657461231949279983444694469635482736518186969715189652218479613635173779751597214338878319299141111741283639784885985555965163353191599263985135827631991534852844651367898823277572632729417426185576832169575867797591642382317616199611334463626578737156831948347336799287623544745892368529712419389334339384754846777521448183136247854149841282636368295269874349674139368928525534491486426949194421571833341789876251296174223945715752268558792473769227293458787433457385338914544428489584349226189928489765323438856599648298592775392917493251937788444295152427891833193244664543857865628964325357942981163355947842548547632436426234854185186969913541456126253758145513419121617669364762158363758623654865518712538782152661836892426858662565274217488229445499249166282588349749678968849551371298182813869743176781917275671424546698665836483466547539518659351668132962847151315942158315464669526397426132976998657113536448345726853769795888319325112781644426591896938619164625392524931831479822896138556881287856644936221834212477418479898755876373319695376181681289587293461274414872959863353168983544991467986731894957697589489761435187239168186773166265243253468223288663858462628571427549826998353271956413791885869521366491746652132664911691272114597677441892532783198585699242817954926114692476573272419428293371129884289565161552517591628122659341466439942154186937833315292743819727636289268151877374355321171567645795956945688989188927456663541382221882924856719215687745815962413657299632198444235513487676683354452838444586459814635311783687928494144537383871653976825539625445637911573267924673867279286691721315444988198684264753874143474312514514131351787741245966555235565483166429734433352951666269521455744575875644585733285284415343332596717449286211888867337739978363591221221874359545747616979434856193357956535889867924883556996911991392821412356298785356344891425523747599783977677742223775345418487919657625894599414861173552562493971867215435694399167722963584968886797439894866929355237736562351274835113962595421297874566391989223471923911915627141688479364985547986151943834629943959385698635945226562454523281338395229521813171374215512382942389333875992274639249114118881354976741339617387818511829412739133815515516883788132421881769923591923624414875848518234314819393994893777133993396719182281874914147779698866146744237239725158553429713383198488973841337991698738438466198629479311534848756748915194961355927189399282858978236346215257458617756632514757274576551723663537669649879276273257432516918134157315861622319693761668351755199483274152398421232211949216972171638843153597938479745257772851723997418898638519838115498327963812626488619741182549889645452489389125254394518768595396467227522936792163798433828612182528459496718554987385989898484361256923738144539446973862871989227356185445153996367371669844775714664677687476426443758243485831885135744695179976266657336567411132356271796478876869876766488385596869667947289293292691518758861689988843559122331483734639618574357542398364255387568981244254899223667755142679741453786189832471462364566395194748649412114792213287924861856468678626652487961622375989123546934368119755421215499544212359384529719629288247287655189748265921227559344715286945942226998393274219549163412918272995176392954719768338311176244969916356963366177528579953524553257266181524593576263647148947928862674288233541415522554564341733777188249235411297334836828725298529199289655929628343421888777918912272928924464578724236676242187391279961372357714632315259963284553399954563886586853783895259373446212438476497961978517457698295956157145624441527416111125994262518517772393291814791466439898621539876764622354588416286919661125735544817365731263175872846359526527959246551289291595191592982166266185761845423841483731598584686597664862222631319321376372376385765259117255315345972685372734895821566161646362546361415921217158689399495657114996726742799344829544967458616374233923953126867588386556742295665584384312322878541291267738777453829828635998797282399721612465152987539395389677354191368633966538323449791495547117969933133542798976134675228851744429894127623932698751149161973948734959331511377742128875319582934248766126839971778829847898611393989629218632835459481722172589198625942881628689624565846643525959178817111145212336552694963518851853856725997157236958866268859162666496458472484686191423386222476298648467385873396189475344478428648857989524472231188828128796469468421672796675149445127492527334417275945378983166693379343766376976868482387644851931535616692135185345533197196281686455473573744374586915163119236318982422719649797599815953169957228654366272399771729559516757775611128195847532999518796477542866894471735184445877824152415123451186813515452529287611282861371948346163343239355956237224981281938235575344315148222719631978497313969873627613388469726742125755359648325394517549218643912966139462278963168784823719933465567831469523626621571595865752961241142973924464378725896951558472164796359942624122371998711915246567816382181823417334716747629487624772222667114422552491689191917773124973118447595525186344431175431558667952413233568655969538398753439341357854761772616461255844515797632135842494169649952683755985781129263852586559322211674334163443296757263463545363593174119652141918571744625237811945735848167363326622513721279835871515635365273266381523256314187334999845154344146221772936255486791727283816368952282251982928538496689338835396318613757561437651231946383249324639596327244434356286227729117562453949329477155458815578138586225218176476775854716371661182671397378831941637963683945522587578237728496355368778696326538579416182213277221498126972563742451747666672731513274926676684475752796728614991424431234269668341942173681331877615277432641387584666699253415724775885913879694512637222213946987396523343261699471685696171398688738744677233157445265611912696313117385655257359192353761223328412934135124319631519156915656754727739658231653871218238226593374427479265713551289258612214345695141852267681585487646958537118925276628253538927413122185199468595162287568924585571736328178326799136483872318317147821557526223697161422599381547342991218895943551768479874133259338381695622449466928594175293658695696184363644451222988372919953775652433661221177626815271117149648687968791578935412221619477734721666481928517354481625718224645756833875768614782939745715526824252245639554531625885726254631327627941967931683778146258194814173236231927355755841683936483486521955753889455191917554187527292285737352426677225222558981243237618752386821174529531744214145881915353345874759865727314699238148533684194248628695484345327522922617564547986863498747512535623555351585129797521647928634596854187676323946839428891792284968169948989171457175891892251872797339554556597863777453967241733823687984147949334146388712778145196196487732298829739556779215233777822259594923456276156856111192172237795381934946638312231738789321349677153347723684493414787391996932411113771942784173782815993371879812544183358755382853839312712233419921875699694873795282267562315117799145174172787355292837371967857821364641939945974526339921444432619264862568855499294926544915437253529921325967667494841479387641722847674853895196466431272966582647984263611152973533465949214146362177624721931175412282417649143736318858566829839872114874425885815234443677179675985466961355615388566565274861592786312786248923427922166753248796345841373643616819911424686162966722338865238885417299374625234355249847146749477672711947165474649435227654922564597446841969157112423232229118219475596945423464598943155649275254835492219754711143497143665629798147117838437397563676494598342396384813351421542116629675518952688481316733838756694649686646142134569539789376672469361595986343883489187837581555875989171286185731291556436333256716565382132311391588242368817127417266788859653531834214657882494914645962379139827323217619842288534119629978699285264656269237249382621312987155784663167646966144254396534263813988367243414476355247667187184139383542936612388123449419938534872739648244434359168818551551828977581844552642579682187597643746514828986952938587757897875535871594745651443695128882992279347143782252464466299473193991898627822525266672526338115138813672448918964316961328241993879317333915413348491387443854249349562967974351329972998628424476626392637952838898581741446177941623672757734481978828778835639915773827296364249722593113411915497735722644189867474145536124291799849612983415842171461988744733867766194967395276634246385811339486141528994196361834569178389923996578728235816271539837296189384763269249294469515186883575131277576876272463925763844615591231463933838772598959295485658488722453881899868482541852596538841587447755413331546666539495772653423692453642944985192792253367477154369768154323358126612378341259299922984823426378799922335343426455639624424172139669162863586851268755385231521597994672746334946711225984898653123154381841581136396897794372332124433582979496244854463661773427457831511829566974366512962131128543522814794393231291627645144682668629265942228761113565726678692336687192882345151796647445737869387873213174561593176886316544178519318416289139196669953229229742599641379258892699725524388775945356835437191573583288741285813515264325118694898947738291246678424528626346373924616432398617932261389523765111854248659723282479389712255144588519743798976758672337873626241957372552136569338864975871817247993283343227542276823337724263875191686996697658638931317231283213957349551582416142455899182427525591647181895964533354946325152829213621519668535474696767313225946619113753281449446815365427125883947556543125538474227927386332524675714778864243137441247815151153833991725599665522365886242875945339751429525453556156953291924432328877697274332727892169898688914641137883962274669441865456381374515977632624992431972796414569357478444927631769766325697238792392285516751272263844525929522835322541938378737156167621956933181122562138965746123194927998344469446963548273651818696971518965221847961363517377975159721433887831929914111174128363978488598555596516335319159926398513582763199153485284465136789882327757263272941742618557683216957586779759164238231761619961133446362657873715683194834733679928762354474589236852971241938933433938475484677752144818313624785414984128263636829526987434967413936892852553449148642694919442157183334178987625129617422394571575226855879247376922729345878743345738533891454442848958434922618992848976532343885659964829859277539291749325193778844429515242789183319324466454385786562896432535794298116335594784254854763243642623485418518696991354145612625375814551341912161766936476215836375862365486551871253878215266183689242685866256527421748822944549924916628258834974967896884955137129818281386974317678191727567142454669866583648346654753951865935166813296284715131594215831546466952639742613297699865711353644834572685376979588831932511278164442659189693861916462539252493183147982289613855688128785664493622183421247741847989875587637331969537618168128958729346127441487295986335316898354499146798673189495769758948976143518723916818677316626524325346822328866385846262857142754982699835327195641379188586952136649174665213266491169127211459767744189253278319858569924281795492611469247657327241942829337112988428956516155251759162812265934146643994215418693783331529274381972763628926815187737435532117156764579595694568898918892745666354138222188292485671921568774581596241365729963219844423551348767668335445283844458645981463531178368792849414453738387165397682553962544563791157326792467386727928669172131544498819868426475387414347431251451413135178774124596655523556548316642973443335295166626952145574457587564458573328528441534333259671744928621188886733773997836359122122187435954574761697943485619335795653588986792488355699691199139282141235629878535634489142552374759978397767774222377534541848791965762589459941486117355256249397186721543569439916772296358496888679743989486692935523773656235127483511396259542129787456639198922347192391191562714168847936498554798615194383462994395938569863594522656245452328133839522952181317137421551238294238933387599227463924911411888135497674133961738781851182941273913381551551688378813242188176992359192362441487584851823431481939399489377713399339671918228187491414777969886614674423723972515855342971338319848897384133799169873843846619862947931153484875674891519496135592718939928285897823634621525745861775663251475727457655172366353766964987927627325743251691813415731586162231969376166835175519948327415239842123221194921697217163884315359793847974525777285172399741889863851983811549832796381262648861974118254988964545248938912525439451876859539646722752293679216379843382861218252845949671855498738598989848436125692373814453944697386287198922735618544515399636737166984477571466467768747642644375824348583188513574469517997626665733656741113235627179647887686987676648838559686966794728929329269151875886168998884355912233148373463961857435754239836425538756898124425489922366775514267974145378618983247146236456639519474864941211479221328792486185646867862665248796162237598912354693436811975542121549954421235938452971962928824728765518974826592122755934471528694594222699839327421954916341291827299517639295471976833831117624496991635696336617752857995352455325726618152459357626364714894792886267428823354141552255456434173377718824923541129733483682872529852919928965592962834342188877791891227292892446457872423667624218739127996137235771463231525996328455339995456388658685378389525937344621243847649796197851745769829595615714562444152741611112599426251851777239329181479146643989862153987676462235458841628691966112573554481736573126317587284635952652795924655128929159519159298216626618576184542384148373159858468659766486222263131932137637237638576525911725531534597268537273489582156616164636254636141592121715868939949565711499672674279934482954496745861637423392395312686758838655674229566558438431232287854129126773877745382982863599879728239972161246515298753939538967735419136863396653832344979149554711796993313354279897613467522885174442989412762393269875114916197394873495933151137774212887531958293424876612683997177882984789861139398962921863283545948172217258919862594288162868962456584664352595917881711114521233655269496351885185385672599715723695886626885916266649645847248468619142338622247629864846738587339618947534447842864885798952447223118882812879646946842167279667514944512749252733441727594537898316669337934376637697686848238764485193153561669213518534553319719628168645547357374437458691516311923631898242271964979759981595316995722865436627239977172955951675777561112819584753299951879647754286689447173518444587782415241512345118681351545252928761128286137194834616334323935595623722498128193823557534431514822271963197849731396987362761338846972674212575535964832539451754921864391296613946227896316878482371993346556783146952362662157159586575296124114297392446437872589695155847216479635994262412237199871191524656781638218182341733471674762948762477222266711442255249168919191777312497311844759552518634443117543155866795241323356865596953839875343934135785476177261646125584451579763213584249416964995268375598578112926385258655932221167433416344329675726346354536359317411965214191857174462523781194573584816736332662251372127983587151563536527326638152325631418733499984515434414622177293625548679172728381636895228225198292853849668933883539631861375756143765123194638324932463959632724443435628622772911756245394932947715545881557813858622521817647677585471637166118267139737883194163796368394552258757823772849635536877869632653857941618221327722149812697256374245174766667273151327492667668447575279672861499142443123426966834194217368133187761527743264138758466669925341572477588591387969451263722221394698739652334326169947168569617139868873874467723315744526561191269631";
var reviewMode = false;

Array.prototype.contains = function(obj) {
    var i = this.length;
    while (i--) {
        if (this[i] === obj) {
            return true;
        }
    }
    return false;
};

function startGame(difficulty){
    switch (difficulty){
        case 1:
            gridX = 3;
            gridY = 3;
            timePerRound = 60;
            max = 6;
            break;
        case 2:
            gridX = 4;
            gridY = 3;
            timePerRound = 60;
            max = 10;
            break;
        case 3:
            gridX = 4;
            gridY = 4;
            timePerRound = 40;
            max = 12;
            break;
        default:
            break;
    }
    startSection()
}
function startSection() {
    xVal = new Array(gridX);
    yVal = new Array(gridY);
    var i = 1;
    while (i <= gridX){
        var t = 0;
        var salt = 0;
        if (isClassroomMode){
            t = pool[seed + salt];
            while (xVal.contains(t)) {
                salt++;
                t = pool[seed + salt];
            }
        } else {
            t = Math.floor(Math.random() * max) + 1;
            while (xVal.contains(t)) {
                t = Math.floor(Math.random() * max) + 1;
            }
        }
        xVal[i-1] = t;
        i++;
    }
    var j = 1;
    while (j <= gridY){
        if (isClassroomMode){
            t = pool[seed + salt];
            while (yVal.contains(t)) {
                salt++;
                t = pool[seed + salt];
            }
        } else {
            t = Math.floor(Math.random() * max) + 1;
            while (yVal.contains(t)) {
                t = Math.floor(Math.random() * max) + 1;
            }
        }
        yVal[j-1] = t;
        j++;
    }
    document.getElementById("postsection").style.display = "none";
    document.getElementById("init").style.display = "none";
    document.getElementById("game").style.display = "flex";
    rounds++;
    var tableHTML = "<div class='game-row' id='timer'>" + timePerRound.toString() + "</div><div class='game-table'><div class='game-row'><p class='blank'></p>";
    i = 1;
    while (i <= gridX){
        tableHTML = tableHTML + "<p class='game-header-x'>" + xVal[i-1].toString() + "</p>";
        i++;
    }
    tableHTML = tableHTML + "</div>";

    j = 1;
    while (j <= gridY){
        tableHTML = tableHTML + "<div class='game-row'>";
        tableHTML = tableHTML + "<p class='game-header-y'>" + yVal[j-1].toString() + "</p>";
        i = 1;
        while (i <= gridX){
            tableHTML = tableHTML + "<input class='game-input' id='" + i.toString() + "-" + j.toString() + "' type='number' />";
            i++;
        }
        tableHTML = tableHTML + "</div>";
        j++;
    }

    tableHTML = tableHTML + "<div class='game-row'><img class='fw-button' id='done-button' onclick='finish();' src='img/done.svg' </div></div>";
    document.getElementById("game").innerHTML = tableHTML;
    startTime();
}
var seconds_left;
function startTime(){
    seconds_left = timePerRound;
    var interval = setInterval(function() {
        document.getElementById('timer').innerHTML = (--seconds_left).toString();

        if (seconds_left <= 0)
        {
            finish();
            clearInterval(interval);
        }
    }, 1000);
}

function finish(){
    var isIncorrect = false;
    var remainingTime = seconds_left;
    seconds_left = 0;

    var j = 1;
    while (j <= gridY) {
        var i = 1;
        while (i <= gridX){
            if (roughScale(document.getElementById(i.toString() + "-" + j.toString()).value, 10)/100 !== (xVal[i-1]*yVal[j-1])){
                isIncorrect = true;
                document.getElementById(i.toString() + "-" + j.toString()).style.color = "#8a8a8a";
            } else {
            }
            i++;
        }
        j++;
    }
    if (!isIncorrect && !reviewMode){
        savedTime += remainingTime;
    }
    reviewMode = false;
    document.getElementById("game").style.display = "none";
    document.getElementById("postsection").style.display = "flex";
    document.getElementById("score-total").innerHTML = savedTime.toString();
}

function levelUp(){
    if (gridX === 4){
        if (gridY === 4){
            if (timePerRound <= 30){
                if (max < 12){
                    max++;
                }
            } else {
                timePerRound -= 2;
            }
        } else {
            gridY++;
        }
    } else {
        gridX++;
    }
    startSection()
}

function roughScale(x, base) {
    var parsed = parseInt(x, base);
    if (isNaN(parsed)) { return 0 }
    return parsed * 100;
}

function review(){
    document.getElementById("postsection").style.display = "none";
    document.getElementById("game").style.display = "flex";
    document.getElementById("timer").innerHTML = "Review";
    reviewMode = true;
}
function fireKeyPress(event){
    switch(event.keyCode){
        case 116:
            isClassroomMode = !isClassroomMode;
            if (isClassroomMode){
                document.getElementById("seed-modal-bg").style.display = "block";
                document.getElementById("title").innerHTML = "Multiply! Now! &#x1f3eb";
            }
            else {
                document.getElementById("seed-modal-bg").style.display = "none";
                document.getElementById("title").innerHTML = "Multiply! Now!";
                //Change to toast
                alert("Classroom mode deactivated");
            }
            break;
        default:
            break;
    }
}

function registerSeed(){
    var temp = roughScale(document.getElementById("seed-num").value, 10)/100;
    while (temp >=10000){
        temp = Math.floor(temp/10);
    }
    seed = temp;
    document.getElementById("seed-modal-bg").style.display = "none";
}

//PSEUDO_RANDOM SEED TEACHER MODE